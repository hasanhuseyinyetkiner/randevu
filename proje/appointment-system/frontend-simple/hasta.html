<\!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hasta Paneli</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <div id="mainSection" class="bg-white rounded-2xl shadow-xl p-8">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900" id="userName"></h1>
                    <p class="text-gray-600">Randevu Sistemi</p>
                </div>
                <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">Çıkış</button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div class="border border-gray-200 rounded-lg p-6">
                    <h2 class="text-xl font-bold mb-4">Yeni Randevu Al</h2>
                    <form id="appointmentForm" class="space-y-4">
                        <div><label class="block text-sm font-medium mb-2">Doktor Seçin</label><select id="doktorSelect" required class="w-full px-3 py-2 border rounded-lg"><option value="">Doktor seçin...</option></select></div>
                        <div><label class="block text-sm font-medium mb-2">Hizmet Seçin</label><select id="hizmetSelect" required class="w-full px-3 py-2 border rounded-lg"><option value="">Önce doktor seçin...</option></select></div>
                        <div><label class="block text-sm font-medium mb-2">Tarih</label><input type="date" id="tarih" required class="w-full px-3 py-2 border rounded-lg"></div>
                        <div><label class="block text-sm font-medium mb-2">Saat</label><input type="time" id="saat" required class="w-full px-3 py-2 border rounded-lg"></div>
                        <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700">Randevu Oluştur</button>
                    </form>
                    <div id="appointmentResult" class="mt-4 text-sm"></div>
                </div>
                <div class="border border-gray-200 rounded-lg p-6">
                    <h2 class="text-xl font-bold mb-4">Randevularım</h2>
                    <button onclick="loadMyAppointments()" class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 mb-4">Yenile</button>
                    <div id="appointmentsList" class="space-y-3 max-h-96 overflow-y-auto"></div>
                </div>
            </div>
        </div>
    </div>
    <script>
        const API_BASE = 'http://localhost:3001/api';
        let currentUser = null;
        let doctors = [];
        let services = [];
        function logout() { window.location.href = 'index.html'; }
        window.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const telefon = urlParams.get('telefon');
            if (\!telefon) { window.location.href = 'index.html'; return; }
            try {
                const response = await fetch(API_BASE + '/check-user', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ telefon }) });
                const data = await response.json();
                if (data.success && data.user) {
                    currentUser = data.user;
                    document.getElementById('userName').textContent = 'Merhaba ' + currentUser.isim + ' ' + currentUser.soyisim;
                    await loadDoctors();
                    await loadMyAppointments();
                } else { window.location.href = 'index.html'; }
            } catch (error) { console.error('Hata:', error); window.location.href = 'index.html'; }
        });
        async function loadDoctors() {
            try {
                const response = await fetch(API_BASE + '/get-users?rol=doktor');
                doctors = await response.json();
                const select = document.getElementById('doktorSelect');
                select.innerHTML = '<option value="">Doktor seçin...</option>';
                doctors.forEach(doc => {
                    const option = document.createElement('option');
                    option.value = doc.id;
                    option.textContent = 'Dr. ' + doc.isim + ' ' + doc.soyisim;
                    option.dataset.name = 'Dr. ' + doc.isim + ' ' + doc.soyisim;
                    select.appendChild(option);
                });
            } catch (error) { console.error('Doktorlar yüklenemedi:', error); }
        }
        document.addEventListener('DOMContentLoaded', () => {
            const doktorSelect = document.getElementById('doktorSelect');
            if (doktorSelect) {
                doktorSelect.addEventListener('change', async (e) => {
                    const doktorId = e.target.value;
                    const hizmetSelect = document.getElementById('hizmetSelect');
                    if (\!doktorId) { hizmetSelect.innerHTML = '<option value="">Önce doktor seçin...</option>'; return; }
                    try {
                        const response = await fetch(API_BASE + '/get-services');
                        services = await response.json();
                        hizmetSelect.innerHTML = '<option value="">Hizmet seçin...</option>';
                        services.forEach(service => {
                            const option = document.createElement('option');
                            option.value = service.ID;
                            option.textContent = service.Isim + ' (' + service.Sure + ' dk)';
                            option.dataset.name = service.Isim;
                            hizmetSelect.appendChild(option);
                        });
                    } catch (error) { console.error('Hizmetler yüklenemedi:', error); }
                });
            }
        });
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById('appointmentForm');
            if (form) {
                form.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const doktorSelect = document.getElementById('doktorSelect');
                    const hizmetSelect = document.getElementById('hizmetSelect');
                    const doktorId = doktorSelect.value;
                    const hizmetId = hizmetSelect.value;
                    const tarih = document.getElementById('tarih').value;
                    const saat = document.getElementById('saat').value;
                    const resultDiv = document.getElementById('appointmentResult');
                    if (\!doktorId || \!hizmetId || \!tarih || \!saat) { resultDiv.innerHTML = '<span class="text-red-600">Lütfen tüm alanları doldurun\!</span>'; return; }
                    try {
                        const response = await fetch(API_BASE + '/add-appointment', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                hastaId: currentUser.id,
                                hastaIsim: currentUser.isim + ' ' + currentUser.soyisim,
                                hastaTelefon: currentUser.telefon,
                                doktorId: doktorId,
                                doktorAdi: doktorSelect.options[doktorSelect.selectedIndex].dataset.name,
                                hizmetId: hizmetId,
                                hizmet: hizmetSelect.options[hizmetSelect.selectedIndex].dataset.name,
                                tarih: tarih,
                                saat: saat,
                                durum: 'bekliyor'
                            })
                        });
                        const data = await response.json();
                        if (data.success) {
                            resultDiv.innerHTML = '<span class="text-green-600">✓ Randevu başarıyla oluşturuldu\!</span>';
                            form.reset();
                            setTimeout(() => { loadMyAppointments(); resultDiv.innerHTML = ''; }, 2000);
                        } else {
                            resultDiv.innerHTML = '<span class="text-red-600">✗ ' + (data.message || 'Randevu oluşturulamadı\!') + '</span>';
                        }
                    } catch (error) { console.error('Hata:', error); resultDiv.innerHTML = '<span class="text-red-600">✗ Bağlantı hatası\!</span>'; }
                });
            }
        });
        async function loadMyAppointments() {
            if (\!currentUser) return;
            try {
                const response = await fetch(API_BASE + '/patient/appointments?telefon=' + currentUser.telefon);
                const data = await response.json();
                const list = document.getElementById('appointmentsList');
                if (\!data.success || (data.upcoming.length === 0 && data.past.length === 0)) {
                    list.innerHTML = '<p class="text-gray-500 text-center py-4">Henüz randevunuz yok</p>';
                    return;
                }
                const allAppointments = [...data.upcoming, ...data.past];
                list.innerHTML = allAppointments.map(apt => {
                    const isDone = apt.Durum === 'onaylandı' || apt.Durum === 'onaylandi';
                    const isCancelled = apt.Durum === 'iptal edildi';
                    const borderColor = isDone ? 'border-green-500 bg-green-50' : isCancelled ? 'border-red-500 bg-red-50' : 'border-yellow-500 bg-yellow-50';
                    const badgeColor = isDone ? 'bg-green-100 text-green-800' : isCancelled ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800';
                    const statusText = isDone ? '✓ Onaylandı' : isCancelled ? '✗ İptal' : '⏳ Bekliyor';
                    const cancelButton = apt.Durum === 'bekliyor' ? '<button onclick="cancelAppointment(\'' + apt.ID + '\')" class="mt-3 w-full bg-red-500 text-white py-2 rounded hover:bg-red-600 text-sm">Randevuyu İptal Et</button>' : '';
                    return '<div class="border-l-4 ' + borderColor + ' p-4 rounded-lg"><div class="flex justify-between items-start"><div><p class="font-bold">' + apt.DoktorAdi + '</p><p class="text-sm text-gray-600">' + (apt.Hizmet || 'Genel Muayene') + '</p><p class="text-sm text-gray-600">' + apt.Tarih + ' - ' + apt.Saat + '</p></div><span class="px-3 py-1 rounded-full text-xs font-semibold ' + badgeColor + '">' + statusText + '</span></div>' + cancelButton + '</div>';
                }).join('');
            } catch (error) { console.error('Randevular yüklenemedi:', error); document.getElementById('appointmentsList').innerHTML = '<p class="text-red-500 text-center py-4">Randevular yüklenemedi</p>'; }
        }
        async function cancelAppointment(id) {
            if (\!confirm('Bu randevuyu iptal etmek istediğinizden emin misiniz?')) return;
            try {
                const response = await fetch(API_BASE + '/cancel-appointment?id=' + id, { method: 'POST' });
                const data = await response.json();
                if (data.success) { alert('✓ Randevu iptal edildi'); loadMyAppointments(); } else { alert('✗ Randevu iptal edilemedi'); }
            } catch (error) { console.error('Hata:', error); alert('✗ Bağlantı hatası'); }
        }
        document.addEventListener('DOMContentLoaded', () => {
            const tarihInput = document.getElementById('tarih');
            if (tarihInput) { const today = new Date().toISOString().split('T')[0]; tarihInput.min = today; }
        });
    </script>
</body>
</html>
